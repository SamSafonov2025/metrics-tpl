// Package pool предоставляет generic-реализацию пула объектов с автоматическим сбросом.
// Объекты, хранящиеся в пуле, должны реализовывать метод Reset() для очистки своего
// состояния перед возвратом в пул для повторного использования.
package pool

import (
	"sync"
)

// Resettable - интерфейс для объектов, которые могут сбрасывать своё состояние к начальным значениям.
// Типы, реализующие этот интерфейс, могут использоваться с Pool.
type Resettable interface {
	Reset()
}

// Pool - generic-пул объектов, который хранит переиспользуемые объекты типа T.
// Объекты автоматически сбрасываются при возврате в пул через Put().
//
// Параметр типа T должен реализовывать интерфейс Resettable.
//
// Пример:
//
//	type MyStruct struct {
//	    Value int
//	    Data  []byte
//	}
//
//	func (m *MyStruct) Reset() {
//	    m.Value = 0
//	    m.Data = m.Data[:0]
//	}
//
//	pool := New(func() *MyStruct {
//	    return &MyStruct{
//	        Data: make([]byte, 0, 1024),
//	    }
//	})
//
//	obj := pool.Get()
//	obj.Value = 42
//	pool.Put(obj) // Reset() вызывается автоматически
type Pool[T Resettable] struct {
	pool *sync.Pool
	new  func() T
}

// New создаёт новый Pool с указанной функцией-конструктором.
//
// Параметр newFunc - это функция, которая создаёт и возвращает новый экземпляр типа T.
// Эта функция вызывается, когда пул пуст и запрашивается новый объект через Get().
//
// Пример:
//
//	pool := New(func() *MyStruct {
//	    return &MyStruct{
//	        Data: make([]byte, 0, 1024),
//	    }
//	})
func New[T Resettable](newFunc func() T) *Pool[T] {
	p := &Pool[T]{
		new: newFunc,
	}

	p.pool = &sync.Pool{
		New: func() interface{} {
			return newFunc()
		},
	}

	return p
}

// Get извлекает объект из пула.
//
// Если пул пуст, создаётся новый объект с помощью функции-конструктора,
// переданной в New().
//
// Возвращаемый объект может быть ранее использован и сброшен, поэтому он должен
// находиться в начальном состоянии.
//
// Пример:
//
//	obj := pool.Get()
//	obj.Value = 100
//	// используем obj...
//	pool.Put(obj)
func (p *Pool[T]) Get() T {
	return p.pool.Get().(T)
}

// Put возвращает объект в пул после сброса его состояния.
//
// Метод Reset() объекта вызывается автоматически перед помещением обратно в пул.
// Это гарантирует, что следующий вызов Get() получит чистый объект.
//
// Безопасно вызывать Put с nil объектом; метод просто вернётся без выполнения
// каких-либо действий.
//
// Пример:
//
//	obj := pool.Get()
//	obj.Value = 42
//	obj.Data = append(obj.Data, []byte("hello")...)
//	pool.Put(obj) // вызывается obj.Reset(), obj.Value становится 0, obj.Data очищается
func (p *Pool[T]) Put(obj T) {
	// Проверяем на nil только если T это интерфейс или указатель
	// Для указателей можем проверить через рефлексию или интерфейс
	// Но проще всего просто вызвать Reset() - если obj nil, метод должен это обрабатывать
	obj.Reset()
	p.pool.Put(obj)
}
