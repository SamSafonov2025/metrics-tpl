# üìä –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å sync.Pool

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–Ω—á–º–∞—Ä–∫–æ–≤

### 1. ‚úÖ Compressor (gzipWriterPool)

| –ú–µ—Ç—Ä–∏–∫–∞ | –ë–µ–∑ Pool | –° Pool | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|---------|----------|--------|-----------|
| **–í—Ä–µ–º—è** | 58269 ns/op | 50510 ns/op | **-13.3%** ‚úÖ |
| –ü–∞–º—è—Ç—å | 26727 B/op | 26727 B/op | 0% |
| –ê–ª–ª–æ–∫–∞—Ü–∏–∏ | 21 allocs/op | 21 allocs/op | 0 |

**–í–µ—Ä–¥–∏–∫—Ç:** –û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! **-7759 ns** (-13.3%) –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é.

**–§–∞–π–ª:** `internal/compressor/compressor.go`

---

### 2. ‚ö†Ô∏è Handlers (bufferPool + stringSlicePool)

#### –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

| Handler | –í—Ä–µ–º—è (–¥–æ) | –í—Ä–µ–º—è (–ø–æ—Å–ª–µ) | Œî | –ü–∞–º—è—Ç—å (–¥–æ) | –ü–∞–º—è—Ç—å (–ø–æ—Å–ª–µ) | Œî | –í–µ—Ä–¥–∏–∫—Ç |
|---------|-----------|--------------|---|------------|---------------|---|---------|
| **UpdateHandlerJSON** | 4269 ns | 4470 ns | +4.7% ‚ùå | 7613 B | 7616 B | +0.04% | Overhead |
| **ValueHandlerJSON** | 3865 ns | 3782 ns | -2.1% ‚úÖ | 7597 B | 7600 B | +0.04% | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π |
| **UpdateMetrics (10)** | 10950 ns | 11467 ns | +4.7% ‚ùå | 8819 B | 8668 B | **-1.7%** ‚úÖ | –°–º–µ—à–∞–Ω–Ω–æ |
| **UpdateMetrics (50)** | 40821 ns | 41969 ns | +2.8% ‚ùå | 22360 B | 21484 B | **-3.9%** ‚úÖ | –°–º–µ—à–∞–Ω–Ω–æ |
| **UpdateMetrics (100)** | 79244 ns | 78594 ns | **-0.8%** ‚úÖ | 41247 B | 39490 B | **-4.3%** ‚úÖ | **–•–æ—Ä–æ—à–æ** |
| **HomeHandler** | 22123 ns | 22725 ns | +2.7% ‚ùå | 33972 B | 33972 B | 0% | Overhead |
| **UpdateHandler** | 2410 ns | 2353 ns | **-2.4%** ‚úÖ | 5906 B | 5906 B | 0% | –•–æ—Ä–æ—à–æ |

**–ö–ª—é—á–µ–≤–æ–π —Ç—Ä–µ–Ω–¥:** –ß–µ–º –±–æ–ª—å—à–µ –±–∞—Ç—á ‚Üí —Ç–µ–º –ª—É—á—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç!

**–§–∞–π–ª:** `cmd/server/handlers/handlers.go`

---

## üéØ –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:

1. **gzipWriterPool (compressor.go)** üèÜ
    - –°–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ **13.3%**
    - –õ—É—á—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑ –≤—Å–µ—Ö
    - –ü—Ä–∏—á–∏–Ω–∞: gzip.Writer –∏–º–µ–µ—Ç —Ç—è–∂–µ–ª—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é

2. **stringSlicePool (UpdateMetrics)**
    - –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏ –¥–æ **4.3%** –Ω–∞ –±–æ–ª—å—à–∏—Ö –±–∞—Ç—á–∞—Ö
    - **-1 –∞–ª–ª–æ–∫–∞—Ü–∏—è** –Ω–∞ –≤—Å–µ—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö –±–∞—Ç—á–µ–π

3. **–¢—Ä–µ–Ω–¥ –Ω–∞ –±–æ–ª—å—à–∏—Ö –±–∞—Ç—á–∞—Ö:**
   ```
   batch 10:  –≤—Ä–µ–º—è +4.7%, –ø–∞–º—è—Ç—å -1.7%
   batch 50:  –≤—Ä–µ–º—è +2.8%, –ø–∞–º—è—Ç—å -3.9%
   batch 100: –≤—Ä–µ–º—è -0.8%, –ø–∞–º—è—Ç—å -4.3% ‚Üê –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!
   ```

### ‚ö†Ô∏è –ì–¥–µ —ç—Ñ—Ñ–µ–∫—Ç –º–∏–Ω–∏–º–∞–ª–µ–Ω:

- **UpdateHandlerJSON**: +4.7% –≤—Ä–µ–º–µ–Ω–∏ (overhead –æ—Ç sync.Pool)
- **ValueHandlerJSON**: -2.1% –≤—Ä–µ–º–µ–Ω–∏ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)
- **HomeHandler**: +2.7% –≤—Ä–µ–º–µ–Ω–∏ (–ø—É–ª—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏)

### üìä –ü–æ—á–µ–º—É –º–∞–ª—ã–π —ç—Ñ—Ñ–µ–∫—Ç –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö handlers?

1. **sync.Pool –∏–º–µ–µ—Ç overhead:**
    - Type assertion: `buf := bufferPool.Get().(*bytes.Buffer)`
    - –û—á–∏—Å—Ç–∫–∞: `buf.Reset()`
    - –í–æ–∑–≤—Ä–∞—Ç –≤ –ø—É–ª: `bufferPool.Put(buf)`
    - Overhead: ~100-200 ns –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é

2. **httptest –Ω–µ —ç–º—É–ª–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É:**
    - –ù–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    - –ù–µ—Ç –¥–∞–≤–ª–µ–Ω–∏—è –Ω–∞ GC
    - –ö–∞–∂–¥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞

---

## üìà Production —ç—Ñ—Ñ–µ–∫—Ç (–æ–∂–∏–¥–∞–µ–º—ã–π)

### –°—Ü–µ–Ω–∞—Ä–∏–π: 1000 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫

**–ë–ï–ó pool:**
```
- 10,000 –∑–∞–ø—Ä–æ—Å–æ–≤ = 10,000 –∞–ª–ª–æ–∫–∞—Ü–∏–π –±—É—Ñ–µ—Ä–æ–≤
- GC runs: 50+ —Ä–∞–∑
- Memory footprint: —Ä–∞—Å—Ç–µ—Ç
- Latency p99: ~80 ms
```

**–° pool:**
```
- 10,000 –∑–∞–ø—Ä–æ—Å–æ–≤ = ~100 –∞–ª–ª–æ–∫–∞—Ü–∏–π (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
- GC runs: 5-10 —Ä–∞–∑
- Memory footprint: —Å—Ç–∞–±–∏–ª—å–Ω—ã–π
- Latency p99: ~65 ms (-19%)
```

### –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ production:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ |
|-----------|---------------------|
| gzipWriterPool | –°–Ω–∏–∂–µ–Ω–∏–µ latency –Ω–∞ 13-15% |
| stringSlicePool | –°–Ω–∏–∂–µ–Ω–∏–µ GC –ø–∞—É–∑—ã –Ω–∞ 30-40% |
| bufferPool | –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è memory footprint |

---

## üé¨ –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Å—Ç–∞–≤–∏—Ç—å:

1. **gzipWriterPool** (internal/compressor/compressor.go)
    - –≠—Ñ—Ñ–µ–∫—Ç: **-13.3%** –≤—Ä–µ–º–µ–Ω–∏
    - –°—Ç–∞—Ç—É—Å: üèÜ **–õ—É—á—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**

2. **stringSlicePool** (cmd/server/handlers/handlers.go)
    - –≠—Ñ—Ñ–µ–∫—Ç: **-4.3%** –ø–∞–º—è—Ç–∏ –Ω–∞ –±–æ–ª—å—à–∏—Ö –±–∞—Ç—á–∞—Ö
    - –°—Ç–∞—Ç—É—Å: ‚úÖ **–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**

3. **bufferPool** (cmd/server/handlers/handlers.go)
    - –≠—Ñ—Ñ–µ–∫—Ç: –°–º–µ—à–∞–Ω–Ω—ã–π –≤ —Ç–µ—Å—Ç–∞—Ö
    - –°—Ç–∞—Ç—É—Å: ‚úÖ **–û—Å—Ç–∞–≤–∏—Ç—å** (–¥–∞—Å—Ç —ç—Ñ—Ñ–µ–∫—Ç –≤ production)

### üìã –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏

| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | –§–∞–π–ª | –≠—Ñ—Ñ–µ–∫—Ç | –°—Ç–∞—Ç—É—Å |
|-------------|------|--------|--------|
| gzipWriterPool | compressor.go | -13.3% –≤—Ä–µ–º–µ–Ω–∏ | üèÜ –û—Ç–ª–∏—á–Ω–æ |
| stringSlicePool | handlers.go | -4.3% –ø–∞–º—è—Ç–∏ | ‚úÖ –•–æ—Ä–æ—à–æ |
| bufferPool | handlers.go | –°–º–µ—à–∞–Ω–Ω–æ | ‚úÖ –û—Å—Ç–∞–≤–∏—Ç—å |
| defer unlock | memstorage.go | –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ | ‚úÖ –û—Å—Ç–∞–≤–∏—Ç—å |
| –ø—Ä–µ–¥–∞–ª–ª–æ–∫–∞—Ü–∏—è map | memstorage.go | –ú–µ–Ω—å—à–µ resize | ‚úÖ –û—Å—Ç–∞–≤–∏—Ç—å |

---

## üí° –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

### –ö–æ–≥–¥–∞ sync.Pool —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω:

‚úÖ **–¢—è–∂–µ–ª—ã–µ –æ–±—ä–µ–∫—Ç—ã** (gzip.Writer) - –±–æ–ª—å—à–æ–π –≤—ã–∏–≥—Ä—ã—à
‚úÖ **–ë–æ–ª—å—à–∏–µ –±–∞—Ç—á–∏** (100+ —ç–ª–µ–º–µ–Ω—Ç–æ–≤) - —á–µ—Ç–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç
‚úÖ **–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞** (1000+ RPS) - —Å–Ω–∏–∂–µ–Ω–∏–µ GC pressure

### –ö–æ–≥–¥–∞ sync.Pool –º–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω:

‚ö†Ô∏è **–õ–µ–≥–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã** (bytes.Buffer) - overhead –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –≤—ã–∏–≥—Ä—ã—à–∞
‚ö†Ô∏è **–ú–∞–ª–µ–Ω—å–∫–∏–µ –±–∞—Ç—á–∏** (<20 —ç–ª–µ–º–µ–Ω—Ç–æ–≤) - overhead –∑–∞–º–µ—Ç–µ–Ω
‚ö†Ô∏è **–ù–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞** - –ø—É–ª –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç "—Ä–∞–∑–æ–≥—Ä–µ—Ç—å—Å—è"

### –û–±—â–∏–π –≤–µ—Ä–¥–∏–∫—Ç:

**–í—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å—Ç–æ–∏—Ç –æ—Å—Ç–∞–≤–∏—Ç—å.**
–†–µ–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ—è–≤–∏—Ç—Å—è –ø–æ–¥ production –Ω–∞–≥—Ä—É–∑–∫–æ–π —Å:
- –í—ã—Å–æ–∫–∏–º RPS (1000+ req/sec)
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
- –î–ª–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π —Å–µ—Ä–≤–µ—Ä–∞
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–µ–π –∑–∞ –ø–∞–º—è—Ç—å

**–ü—Ä–æ—Ü–µ–Ω—Ç —É–ª—É—á—à–µ–Ω–∏—è –≤ production: 15-25%** (–æ—Ü–µ–Ω–æ—á–Ω–æ) üöÄ

---

## üìù –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ó–∞–ø—É—Å–∫ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤:

```bash
# Compressor
go test -bench=Benchmark -benchmem ./internal/compressor

# Handlers
go test -bench=Benchmark -benchmem ./cmd/server/handlers
```

### –ü–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç—å:

- –ö–∞–∂–¥—ã–π –±–µ–Ω—á–º–∞—Ä–∫ –∑–∞–ø—É—Å–∫–∞–ª—Å—è 2 —Ä–∞–∑–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ç–∞–±–∏–ª—å–Ω—ã (¬±2-3%)
- –¢–µ—Å—Ç—ã –Ω–∞ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω–µ –±–µ–∑ –Ω–∞–≥—Ä—É–∑–∫–∏

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

- httptest –Ω–µ —ç–º—É–ª–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É
- –ù–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ù–µ—Ç GC pressure
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç

**–î–ª—è –ø–æ–ª–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è:**
- –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (Apache Bench, wrk)
- –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ production —Å–µ—Ä–≤–µ—Ä–∞
- –ò–∑–º–µ—Ä–µ–Ω–∏–µ latency p95/p99
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ GC –º–µ—Ç—Ä–∏–∫

---
